<div id='chart'></div>

<script src='/javascripts/metrics.js'></script>
<script src='/javascripts/defiant.js'></script>
<script>
$.getJSON(document.URL, function(json) {
  graph(json)
  var picker = $('#boxcolour, #textcolour').colorpicker()

  picker.on('changeColor', function(ev){
    $(this).next('input').val(ev.color.toHex().replace('#', ''));

    if (ev.target.id == 'textcolour') {
      var textcolour = ev.color.toHex()
      var boxcolour = $('input[name="boxcolourpicker"]').val()
    } else {
      var textcolour = $('input[name="textcolourpicker"]').val()
      var boxcolour = ev.color.toHex()
    }

    chart.data[0].line.color = textcolour
    chart.layout.paper_bgcolor = boxcolour
    chart.layout.plot_bgcolor = boxcolour
    chart.layout.titlefont.color = textcolour
    chart.layout.xaxis.tickfont.color = textcolour
    chart.layout.yaxis.tickfont.color = textcolour

    Plotly.redraw(chart)
    updateEmbedCode(boxcolour, textcolour)
  });

})

function graph(json) {
  var points = getPoints(json['values'])
  var data = {
    x: points['x'],
    y: points['y'],
    type: 'scatter',
    line: {
      shape: 'spline',
      width: 2,
      smoothing: 1.3,
      color: '<%= @textcolour %>'
    },
  }

  var layout = {
    title: extractTitle(document.URL),
    titlefont: {
      color: '<%= @textcolour %>'
    },
    paper_bgcolor: '<%= @boxcolour %>',
    plot_bgcolor: '<%= @boxcolour %>',
    xaxis: {
      gridcolor: '#D3D3D3',
      type: 'datetime',
      tickangle: 315,
      tickformat: "%Y-%m-%d",
      tickfont: {
        color: '<%= @textcolour %>'
      }
    },
    yaxis: {
      gridcolor: '#D3D3D3',
      tickangle: 315,
      tickfont: {
        color: '<%= @textcolour %>'
      }
    },
    margin: {
      l: 70, r: 30
    }
  }

  Plotly.newPlot(
    'chart',
    [ data ],
    layout,
    { displayModeBar: <%= @plotly_modebar %> }
  );
}
</script>
